<!DOCTYPE html>
<html>
<head>	
	<title>Демонстрация выбора направления</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 600px;
			height: 400px;
		}
	</style>
</head>
<body>

<div id='map'></div>
<script>
    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            osm = L.tileLayer(osmUrl, { maxZoom: 20, attribution: osmAttrib }),
            map = new L.Map('map', { center: new L.LatLng( 59.6931881, 30.4437972), zoom: 16 }),
            drawnItems = L.featureGroup().addTo(map);
    L.control.layers({
        'osm': osm.addTo(map),
        "google": L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
            attribution: 'google'
        })
    }).addTo(map);
   

var iniclick = true;
var φλ0, φλ1;
var coordline;
var ini_marker;

function onMapClick(e) {
    var φλ = [e.latlng.lat, e.latlng.lng];
    if (iniclick){
        φλ0 = φλ;
        iniclick = false;
        if (coordline)
            map.removeLayer(coordline);
        if (ini_marker)
            map.removeLayer(ini_marker);
        ini_marker = L.marker(φλ0).bindPopup('Точка изображения').addTo(map);
        ini_marker.on('click', onMarkerClick);

    } else {
        iniclick = true;
        φλ1 = φλ;
        coordline = L.polyline([
            φλ0,  φλ1
        ], {color: '#FF0000', width: 1}).addTo(map);
        var res = Δl_azimut (φλ0, φλ1);

        L.popup().setLatLng(e.latlng)
			.setContent("≈" + res.Δl_m + " м, ∡ ≈" + res.α + "° </br>Направление: " + geo_α (res.α))
			.openOn(map);
    }
}

function onMarkerClick(e) {
        iniclick = true;
        φλ1 = null;
        L.popup().setLatLng({lat: φλ0[0], lng: φλ0[1]})
			.setContent(" Не выбрано направление, устанавливается в другом месте")
			.openOn(map);    
}

function geo_α (α)
{
    var x = Math.floor(α/22.5);
    if (x>=1 && x<3)
        return "СВ";
    if (x>=3 && x<5)
        return "В";
    if (x>=5 && x<7)
        return "ЮВ";
    if (x>=7 && x<9)
        return "Ю";
    if (x>=9 && x<11)
        return "ЮЗ";
    if (x>=11 && x<13)
        return "З";
    if (x>=13 && x<15)
        return "СЗ";
    if (x>=15 || x<1)
        return "С";
}

function Δl_azimut (φλ0, φλ1) {
    function rad (x)
        { return x * Math.PI/180; }
    var φ1 = rad (φλ0[0]); var λ1 = rad (φλ0[1]);
    var φ2 = rad (φλ1[0]); var λ2 = rad (φλ1[1]);
    var Δφ = rad (φλ1[0]-φλ0[0]);
    var Δλ = rad (φλ1[1]-φλ0[1]);

    var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
          Math.cos(φ1) * Math.cos(φ2) *
          Math.sin(Δλ/2) * Math.sin(Δλ/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    const R_m = 6371e3; // r ♁
    var Δl_m = R_m * c;

    var y = Math.sin(λ2-λ1) * Math.cos(φ2);
    var x = Math.cos(φ1)*Math.sin(φ2) -
          Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
    var θ = Math.atan2(y, x);
    var α = (θ*180/Math.PI + 360) % 360; // °
    return {
        Δl_m: Δl_m.toFixed(2),
        α:α.toFixed(3)
    };
}

map.on('click', onMapClick);
</script>
</body>
</html>
